<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ballot UI</title>
</head>
<body>
    <h1>Ballot</h1>
    <h2>Proposals</h2>
    <ul id="proposalsList">
        <!-- Populate this list dynamically with proposals -->
    </ul>
    
    <h2>Delegate Vote</h2>
    <input type="text" id="delegateAddress" placeholder="Enter delegate address">
    <button onclick="delegateVote()">Delegate</button>

    <h2>Vote</h2>
    <div id="voteOptions">
        <!-- Populate this section dynamically with vote options -->
    </div>

    <h2>User Status</h2>
    <p id="userStatus"></p>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.2/web3.min.js"></script>
    <script src="Ballot.js"></script>
    <script>
        let contract;
        window.addEventListener('load', async () => {
          // Initialize web3
          if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            await ethereum.enable();
          } else if (window.web3) {
            window.web3 = new Web3(web3.currentProvider);
          } else {
            console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            return;
          }

            // Set up contract
            const contractAddress = '0xfd7C89934698c608d7746cbd267303c5a9B60914'; // Replace with your contract address
            const contractAbi = BallotAbi; // Replace with your contract ABI
            contract = new web3.eth.Contract(contractAbi, contractAddress);

            // Get proposals and populate list
            const proposals = await contract.methods.getProposals().call();
            const proposalsList = document.getElementById('proposalsList');
            proposals.forEach((proposal, index) => {
                const li = document.createElement('li');
                li.textContent = `${index + 1}. ${proposal}`;
                proposalsList.appendChild(li);
            });

            // Check user status
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const userAddress = accounts[0];
            console.log("User Address:", userAddress);
            const hasVoted = await contract.methods.hasVoted(userAddress).call();
            const voterExists = await contract.methods.checkVoterExists(userAddress).call();
            const userStatus = document.getElementById('userStatus');
            if (hasVoted && voterExists) {
                userStatus.textContent = `You have already voted.`;
            } else if(voterExists && !hasVoted) {
                userStatus.textContent = 'You can click on one of the proposals to vote for them or wish to delegate your vote';
            } else if(!voterExists && !hasVoted){
                userStatus.textContent = 'You can click on one of the proposals to vote for them or wish to delegate your vote';
                await contract.methods.initializeVoter(userAddress).send({ from: userAddress });
            }

            // Populate vote options
            const voteOptions = document.getElementById('voteOptions');
            proposals.forEach((proposal, index) => {
                const button = document.createElement('button');
                button.textContent = `Vote for ${proposal}`;
                button.onclick = () => vote(index);
                voteOptions.appendChild(button);
            });
        });

        async function delegateVote() {
            const delegateAddress = document.getElementById('delegateAddress').value;
            const accounts = await web3.eth.getAccounts(); // Get the accounts from MetaMask
            const senderAddress = accounts[0]; // Use the first account as the sender address

            await contract.methods.delegate(delegateAddress).send({ from: senderAddress }); // Pass sender address as "from" option
            location.reload(); // Refresh page
        }

        async function vote(proposalIndex) {
            const accounts = await web3.eth.getAccounts(); // Get the accounts from MetaMask
            const senderAddress = accounts[0]; // Use the first account as the sender address
            await contract.methods.vote(proposalIndex).send({ from: senderAddress }); // Pass sender address as "from" option
            location.reload(); // Refresh page
        }
    </script>
</body>
</html>
